<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Transformation</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* New palette only – layout unchanged */
      :root {
        --bg: #0c1226;
        --panel: #121a36;
        --text: #eaf2ff;
        --muted: #a3acd6;
        --primary: #1aeea1;
        --accent: #6b7cff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          Inter,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: linear-gradient(180deg, #0b122a, #0d1533);
        color: var(--text);
      }
      .wrap {
        max-width: 820px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .card {
        background: linear-gradient(180deg, #131a3a, #0f1530);
        border: 1px solid #263064;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      h1 {
        font-size: 22px;
        margin: 0 0 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      select,
      input,
      button {
        appearance: none;
        background: #0f1634;
        color: var(--text);
        border: 1px solid #2d3a73;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
      }
      button {
        background: linear-gradient(180deg, var(--primary), #12d08e);
        border-color: #10c985;
        color: #0b1020;
        font-weight: 700;
      }
      button:hover {
        filter: brightness(1.06);
      }
      .chat {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 520px;
        overflow: auto;
        padding-right: 4px;
      }
      .msg {
        max-width: 80%;
        padding: 10px 12px;
        border-radius: 12px;
        line-height: 1.45;
      }
      .a {
        align-self: flex-start;
        background: #10183a;
        border: 1px solid #25306a;
      }
      .u {
        align-self: flex-end;
        background: #142a57;
        border: 1px solid #1e448a;
        color: #eaf2ff;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      /* Typing indicator */
      .typing {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .typing .dot {
        width: 6px;
        height: 6px;
        background: var(--muted);
        opacity: 0.35;
        border-radius: 50%;
        display: inline-block;
        animation: blink 1.2s infinite ease-in-out;
      }
      .typing .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes blink {
        0%,
        80%,
        100% {
          opacity: 0.2;
        }
        40% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h1>AI Transformation</h1>
          <div style="display: flex; align-items: center; gap: 10px">
            <span class="muted" id="userInfo"></span>
            <button id="signin">Sign in</button>
            <img
              src="https://sightcall.com/wp-content/uploads/SightCall-White-Logo-1.svg"
              style="height: 22px"
            />
          </div>
        </div>
        <div class="row" style="margin-top: 8px">
          <label>Department</label>
          <select id="department">
            <option value="hr">HR</option>
            <option value="sales">Sales</option>
            <option value="marketing">Marketing</option>
          </select>
          <button id="start">Start</button>
          <span class="muted" id="sidInfo"></span>
        </div>
        <div class="chat" id="chat"></div>
        <div class="row" style="margin-top: 10px">
          <input id="input" placeholder="Your message..." />
          <button id="send">Send</button>
        </div>
        <div class="muted" id="hint"></div>
      </div>
    </div>
    <script>
      const $ = (s) => document.querySelector(s);
      const base = location.origin;
      let sessionId = null;
      let currentNodeKey = null;
      let currentType = null;
      let currentValidations = {};
      let done = false;
      let typingEl = null;
      let typingShownAt = 0;
      const TYPING_MIN_MS = 800; // minimum time the typing indicator remains visible
      let authUser = null; // filled after SSO

      // Load departments from API and populate the dropdown
      const loadDepartments = async () => {
        const sel = $("#department");
        try {
          const r = await fetch(`${base}/api/department`);
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const j = await r.json();
          if (Array.isArray(j?.departments) && j.departments.length) {
            sel.innerHTML = j.departments
              .map(
                (d) =>
                  `<option value="${String(d.key)}">${String(d.name || d.key)}</option>`,
              )
              .join("");
          }
        } catch (e) {
          console.warn("Failed to load departments, using fallback options", e);
          // Keep existing static options as fallback
        }
      };

      const push = (role, text) => {
        const el = document.createElement("div");
        el.className = `msg ${role === "assistant" ? "a" : "u"}`;
        el.textContent = text;
        $("#chat").appendChild(el);
        $("#chat").scrollTop = $("#chat").scrollHeight;
      };

      const askWithAI = async (rawText, type, validations) => {
        try {
          const constraints = [];
          if (type === "number") {
            if (typeof validations?.min === "number")
              constraints.push(`min: ${validations.min}`);
            if (typeof validations?.max === "number")
              constraints.push(`max: ${validations.max}`);
          }
          const prompt =
            `Rewrite the following instruction into a brief, friendly, and clear question in English, without adding information: "${rawText}". ` +
            (constraints.length
              ? `Constraints to mention: ${constraints.join(", ")}. `
              : "") +
            `Reply with the reformulated question only.`;
          const r = await fetch(`${base}/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId, message: prompt }),
          });
          if (!r.ok) return rawText;
          const j = await r.json().catch(() => ({}));
          return j && j.reply ? String(j.reply) : rawText;
        } catch {
          return rawText;
        }
      };

      const setQuestion = async ({
        nodeKey,
        questionText,
        type,
        validations,
      }) => {
        currentNodeKey = nodeKey || null;
        currentType = type || null;
        currentValidations = validations || {};
        if (questionText) {
          // Reformuler avec l'IA (fallback si échec)
          const reformulated = await askWithAI(questionText, type, validations);
          push("assistant", reformulated || questionText);
          const hints = [];
          if (type === "number") {
            if (typeof validations?.min === "number")
              hints.push(`min ${validations.min}`);
            if (typeof validations?.max === "number")
              hints.push(`max ${validations.max}`);
            $("#input").setAttribute("inputmode", "numeric");
            $("#input").setAttribute("placeholder", "Enter a number...");
          } else {
            $("#input").removeAttribute("inputmode");
            $("#input").setAttribute("placeholder", "Your message...");
          }
          $("#hint").textContent = hints.join(" · ");
          // Enable input and send now that a question is present
          $("#input").disabled = false;
          $("#send").disabled = false;
          $("#input").focus();
          // Now that the question is displayed, hide typing
          hideTyping();
        }
      };

      const start = async () => {
        // Require auth
        if (!authUser) {
          push("assistant", "Please sign in first.");
          return;
        }
        const departmentKey = $("#department").value;
        const r = await fetch(`${base}/api/session/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ departmentKey }),
        });
        const j = await r.json();
        sessionId = j.sessionId;
        $("#sidInfo").textContent = `Session: ${sessionId}`;
        push("assistant", `Hello! I will ask you a few questions.`);
        // Get the first question
        const q = await next();
        if (q?.done) finish();
      };

      const next = async (answerValue) => {
        const payload =
          answerValue === undefined
            ? {}
            : { answer: answerValue, nodeKey: currentNodeKey };
        // Show typing indicator while waiting for the next question
        showTyping();
        const r = await fetch(`${base}/api/session/${sessionId}/answer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!r.ok) {
          const e = await r.json().catch(() => ({}));
          hideTyping();
          push("assistant", `Error: ${r.status} ${JSON.stringify(e)}`);
          return { done: false };
        }
        const j = await r.json();
        await setQuestion(j.nextQuestion || {});
        done = !!j.done;
        if (done) finish();
        return j;
      };

      const finish = () => {
        hideTyping();
        push(
          "assistant",
          "Thank you for your time. We will contact you soon for the AI transformation.",
        );
        $("#input").disabled = true;
        $("#send").disabled = true;
      };

      // Typing indicator helpers
      const showTyping = () => {
        if (typingEl) return;
        const el = document.createElement("div");
        el.className = "msg a typing";
        el.innerHTML =
          '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        $("#chat").appendChild(el);
        $("#chat").scrollTop = $("#chat").scrollHeight;
        typingEl = el;
        typingShownAt = Date.now();
      };
      const hideTyping = () => {
        if (!typingEl) return;
        const elapsed = Date.now() - typingShownAt;
        const remaining = TYPING_MIN_MS - elapsed;
        const removeEl = () => {
          if (typingEl) {
            typingEl.remove();
            typingEl = null;
          }
        };
        if (remaining > 0) {
          setTimeout(removeEl, remaining);
        } else {
          removeEl();
        }
      };

      const send = async () => {
        if (!sessionId || done) return;
        let value = $("#input").value;
        if (currentType === "number") {
          const n = Number(value);
          if (Number.isNaN(n)) {
            push("assistant", "Please enter a number.");
            return;
          }
          value = n;
        } else {
          if (!value || !value.trim()) {
            push("assistant", "Please enter a message.");
            return;
          }
        }
        push("user", String(value));
        $("#input").value = "";
        await next(value);
      };

      $("#start").addEventListener("click", start);
      $("#send").addEventListener("click", send);
      $("#input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") send();
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadDepartments();
        // Disable input and send until the first question arrives
        $("#input").disabled = true;
        $("#send").disabled = true;
        // Disable start until authenticated
        $("#start").disabled = true;
        checkAuth();
      });

      // Auth helpers
      const checkAuth = async () => {
        try {
          const r = await fetch(`${base}/api/auth/me`, {
            credentials: "same-origin",
          });
          if (r.status === 200) {
            const j = await r.json();
            authUser = j.user || null;
            $("#userInfo").textContent = authUser?.email
              ? `Signed in: ${authUser.email}`
              : "Signed in";
            $("#signin").style.display = "none";
            $("#start").disabled = false;
          } else {
            authUser = null;
            $("#userInfo").textContent = "";
            $("#signin").style.display = "";
            $("#start").disabled = true;
          }
        } catch {
          authUser = null;
          $("#userInfo").textContent = "";
          $("#signin").style.display = "";
          $("#start").disabled = true;
        }
      };

      $("#signin").addEventListener("click", () => {
        // Redirect to SAML login
        window.location.href = `${base}/api/auth/login`;
      });
    </script>
  </body>
</html>
